<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Soundcork Management</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { padding: 5px 10px; cursor: pointer; }
        .status { margin-top: 10px; padding: 10px; border: 1px solid #ccc; display: none; }
        .summary-box { margin-top: 20px; padding: 15px; border: 1px solid #aaa; background-color: #f9f9f9; display: none; }
        pre { background-color: #eee; padding: 10px; overflow-x: auto; font-size: 12px; }
        .diff-container { display: flex; gap: 10px; }
        .diff-pane { flex: 1; min-width: 0; }
        .config-header { font-weight: bold; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>
    <h1>Soundcork Management</h1>
    <h2>Discovered Devices</h2>
    <div id="device-list">Loading devices...</div>

    <div id="manual-entry" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
        <h3>Manual Entry</h3>
        <input type="text" id="manual-ip" placeholder="Device IP (e.g. 192.168.1.100)">
        <button onclick="showSummary(document.getElementById('manual-ip').value)">Check Migration</button>
    </div>

    <div id="status" class="status"></div>

    <div id="migration-summary" class="summary-box">
        <h3>Migration Summary for <span id="summary-ip"></span></h3>
        <p>SSH Connection: <span id="ssh-status"></span></p>
        <div class="diff-container">
            <div class="diff-pane">
                <span class="config-header">Current Config (on Speaker)</span>
                <pre id="current-config"></pre>
            </div>
            <div class="diff-pane">
                <span class="config-header">Planned Config (Soundcork)</span>
                <pre id="planned-config"></pre>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <button id="confirm-migrate-btn" style="background-color: #4CAF50; color: white; border: none; padding: 10px 20px;">Confirm Migration & Reboot</button>
            <button onclick="document.getElementById('migration-summary').style.display='none'" style="padding: 10px 20px;">Cancel</button>
        </div>
    </div>

    <script>
        async function fetchDevices() {
            try {
                const response = await fetch('/setup/devices');
                const devices = await response.json();
                const container = document.getElementById('device-list');

                if (devices.length === 0) {
                    container.innerHTML = 'No devices found.';
                    return;
                }

                let html = '<table><tr><th>Name</th><th>IP Address</th><th>Model</th><th>Serial Number</th><th>Action</th></tr>';
                devices.forEach(d => {
                    html += `
                        <tr>
                            <td>${d.name}</td>
                            <td>${d.ip_address}</td>
                            <td>${d.product_code}</td>
                            <td>${d.device_serial_number}</td>
                            <td><button onclick="showSummary('${d.ip_address}')">Prepare Migration</button></td>
                        </tr>
                    `;
                });
                html += '</table>';
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('device-list').innerHTML = 'Error loading devices: ' + error;
            }
        }

        async function showSummary(ip) {
            if (!ip) {
                alert('Please enter a valid IP address.');
                return;
            }
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#ffffcc';
            statusDiv.innerHTML = 'Fetching summary for ' + ip + '...';

            try {
                const response = await fetch('/setup/summary/' + ip);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                const summary = await response.json();

                statusDiv.style.display = 'none';
                document.getElementById('summary-ip').innerText = ip;
                document.getElementById('ssh-status').innerText = summary.ssh_success ? '✅ Success' : '❌ Failed';
                document.getElementById('ssh-status').style.color = summary.ssh_success ? 'green' : 'red';

                const currentConfigElem = document.getElementById('current-config');
                currentConfigElem.innerText = summary.current_config;
                currentConfigElem.style.color = summary.ssh_success ? 'black' : 'red';

                document.getElementById('planned-config').innerText = summary.planned_config;

                const migrateBtn = document.getElementById('confirm-migrate-btn');
                migrateBtn.onclick = () => migrate(ip);
                migrateBtn.disabled = !summary.ssh_success;

                document.getElementById('migration-summary').style.display = 'block';
                document.getElementById('migration-summary').scrollIntoView();
            } catch (error) {
                statusDiv.style.backgroundColor = '#ffcccc';
                statusDiv.innerHTML = 'Error fetching summary for ' + ip + ': ' + error;
            }
        }

        async function migrate(ip) {
            if (!ip) {
                alert('Please enter a valid IP address.');
                return;
            }
            const summaryDiv = document.getElementById('migration-summary');
            summaryDiv.style.display = 'none';

            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#ffffcc';
            statusDiv.innerHTML = 'Migrating ' + ip + '...';

            try {
                const response = await fetch('/setup/migrate/' + ip, { method: 'POST' });
                const result = await response.json();
                if (result.ok) {
                    statusDiv.style.backgroundColor = '#ccffcc';
                    statusDiv.innerHTML = 'Successfully started migration for ' + ip + '. The speaker will reboot.';
                } else {
                    statusDiv.style.backgroundColor = '#ffcccc';
                    statusDiv.innerHTML = 'Migration failed for ' + ip + ': ' + (result.message || 'Unknown error');
                }
            } catch (error) {
                statusDiv.style.backgroundColor = '#ffcccc';
                statusDiv.innerHTML = 'Error migrating ' + ip + ': ' + error;
            }
        }

        fetchDevices();
    </script>
</body>
</html>
